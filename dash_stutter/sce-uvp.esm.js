/* SIE CONFIDENTIAL PlayStation(R)5 Programmer Tool Runtime Library Release 2.00.00.09-00.00.00.0.1
 * Copyright (C) 2019 Sony Interactive Entertainment Inc.
 */

const t={};var e={set(e,s){t[e]=s},get:e=>t[e]};const s={},i=[];var r={define(t){s[t.id]&&console.error("redundant import of adapter ".concat(t.id)),s[t.id]=t},use(t,e,r,a){if("string"==typeof t){t=t.toUpperCase();const n=s[t];r&&(n.symbol=r),i.push({Class:function(e){return new s[t](e,a)},comparator:e});const o="function"==typeof e?"conditionally":"unconditionally";console.info("".concat("SceUvp >> ").concat(o,' using player adapter "').concat(n.id,'"'))}else t.constructor===Array?t.forEach(t=>this.use(t)):"object"==typeof t&&this.use(t.playerName,t.comparator,t.symbol,t.config)},get(t,s){if(0===i.length)throw new Error('Call SceUvp.use("player-name", ...) to define src-matching rule before assigning a src to a SceUvp.Player');for(const e of i)if("function"!=typeof e.comparator||e.comparator(t,s))return e.Class;const r=e.get("html5Video");if(!r)throw new Error("no adapter");return r}},a={use(){return r.use.apply(r,arguments)},get Player(){return e.get("Player")},get Controls(){return e.get("Controls")}};const n="DISPATCH",o="EMIT";class l{constructor(){this.subscribers=[],this.commandSubscribers=[],this.queue=[]}subscribe(t){this.subscribers.includes(t)?console.warn("Subscriber already subscribed to UVP EventBus"):this.subscribers.push(t)}subscribeToCommands(t){this.commandSubscribers.includes(t)?console.warn("Subscriber already subscribed to UVP EventBus"):this.commandSubscribers.push(t)}unsubscribe(t,e=!1){let s=this.subscribers.indexOf(t);~s?this.subscribers.splice(s,1):(s=this.commandSubscribers.indexOf(t),~s?this.commandSubscribers.splice(s,1):!e&&console.warn("Subscriber not subscribed to UVP EventBus"))}dispatch(t,e={}){const s={type:t,data:e,category:n};this.queue.push(s),this.flush()}emit(t,e={}){const s={type:t,data:e,category:o};this.queue.push(s),this.flush()}flush(){if(this.flushing)return;this.flushing=!0;let t=this.queue.shift(),e=t.category;switch(delete t.category,e){case n:this.commandSubscribers.forEach(e=>e(t));break;case o:this.subscribers.forEach(e=>e(t))}return this.flushing=!1,this.queue.length?this.flush():void 0}}const d={LOAD:"LOAD",READY:"READY",METADATA:"METADATA",CUED:"CUED",PLAY:"PLAY",PAUSE:"PAUSE",PLAY_PAUSE:"PLAY_PAUSE",STOP:"STOP",CLOSED_CAPTIONS:"CLOSED_CAPTIONS",COMPLETE:"COMPLETE",PLAYING:"PLAYING",PAUSED:"PAUSED",SEEK:"SEEK",SKIP_FWD:"SKIP_FWD",SKIP_BACK:"SKIP_BACK",SKIP_APPLY:"SKIP_APPLY",SKIPPING:"SKIPPING",SEEKING:"SEEKING",SEEKED:"SEEKED",PLAYBACKRATE_CHANGE:"PLAYBACKRATE_CHANGE",BUFFERING:"BUFFERING",ERROR:"ERROR",TIMEUPDATE:"TIMEUPDATE",OPTIONS:"OPTIONS",CAN_PLAY_THROUGH:"CAN_PLAY_THROUGH"},c={READY:d.READY,PLAYING:d.PLAYING,PAUSED:d.PAUSED,COMPLETE:d.COMPLETE,BUFFERING:d.BUFFERING,ERROR:d.ERROR},u="4K",h={NO_ERROR:0,INVALID_OPTIONS:1,RESOURCES_STARVED:2,NETWORK_ERROR:3,TEXT_ERROR:4,MEDIA_ERROR:5,MANIFEST_ERROR:6,DRM_ERROR:7,NOT_SUPPORTED:8,PLAYER_ERROR:9},p={[h.NO_ERROR]:"No error",[h.INVALID_OPTIONS]:"Invalid options or parameters detected",[h.RESOURCES_STARVED]:"Insufficient resources available to complete the operation",[h.NETWORK_ERROR]:"Error from the network stack",[h.TEXT_ERROR]:"Error parsing text stream",[h.MEDIA_ERROR]:"Error parsing or processing audio or video stream",[h.MANIFEST_ERROR]:"Error parsing or loading a manifest",[h.DRM_ERROR]:"Error related to DRM or other content protection",[h.NOT_SUPPORTED]:"Content is invalid or unsupported",[h.PLAYER_ERROR]:"Miscellaneous error from a player (Native, YouTube, Twitch etc.)."},m="HLS",v="DASH",E="NATIVE",g="HTML5",y="SHAKA",_=["src","type","in","out","drm","coreResourceType","audioPassThrough","telemetry","isDev"],b={};function T(t){return!isNaN(parseFloat(t))}b.format=t=>{const e=b.getObj(t);if(!e)return null;const s=e.h?e.h:"",i=e.h?":".concat(e.mm):e.m,r=e.ss;return"".concat(e.sign).concat(s).concat(i,":").concat(r)},b.getProgress=(t,e,s=1)=>T(e)&&0!==e&&T(t)?Math.max(Math.min(t*s/e,s),0):null,b.getObj=(t,e={})=>{const s=e;if(!Number.isInteger(parseInt(t+"",10)))return null;const i=Math.abs(Math.round(t));return s.h=Math.floor(i/3600),s.m=Math.floor(i%3600/60),s.s=i%60,s.sign=t<0?"-":"",s.hh=(s.h<10?"0":"")+s.h,s.mm=(s.m<10?"0":"")+s.m,s.ss=(s.s<10?"0":"")+s.s,s},S.SKIP_INCREMENT_SEC=10,S.SKIP_INCREMENT_THROTTLE_MS=500;const f=[d.PLAYING,d.BUFFERING];function S(t,e){let s,i=null;function r(s){if(!i||!i.seeking)try{const r=s===d.SKIP_FWD,n=i?i.wasPlaying:f.includes(t.playbackState);let l=!!i&&!!i.isPaused;const c=e||S.SKIP_INCREMENT_SEC,u=("object"==typeof c?c.forward:0)||c,h=("object"==typeof c?c.back:0)||c,p=r?u:-h;let m;m=i?i.initialPosition:t.position;const v=t.duration,E=i&&i.deltaSec||0,g=m+E;let y=!1,_=!1;const b=g+p;let T;if(t.isLive?b<0?(_=!0,T=g):b>=v?(T=v,y=!0):T=b:b<=t.minPosition?(T=t.minPosition,y=!0):b>=t.maxPosition?(_=!0,T=g):T=b,!i&&_)return;i||_||!n||y||(t.eventBus.dispatch(d.PAUSE,{silent:!0}),l=!0);const P=E+(T-g),R=m+P;let k;i&&clearTimeout(i.throttle),y||(k=setTimeout(()=>o(R),S.SKIP_INCREMENT_THROTTLE_MS));if(a({deltaSign:0!==P?P>0?1:-1:r?1:-1,initialPosition:m,duration:v,wasPlaying:n,isPaused:l,deltaSec:P,targetTime:R,throttle:k}),y)return void o(T)}catch(t){console.error("Exception caught in skip throttle - exiting throttle state",t),o()}}function a(e){i=e,t.eventBus.emit(d.SKIPPING,i)}function n(){i.wasPlaying&&i.isPaused&&t.eventBus.dispatch(d.PLAY,{silent:!0})}function o(e){if(clearTimeout(s),t.eventBus.unsubscribe(l,!0),i){if(null==e||!i.deltaSec)return n(),void a(null);t.eventBus.subscribe(l),t.eventBus.dispatch(d.SKIP_APPLY,{...i,position:e}),i.seeking=!0}}function l(e){e.type===d.SEEKED&&(t.eventBus.unsubscribe(l),n(),s=setTimeout(()=>a(null),0))}return r.abort=()=>o(),r}S.format=function(t){return b.format(Math.abs(Math.floor(t)))};const P={getMinSeekPosition:(t,e=!1)=>e?-(t.in||0):0,getMaxSeekPosition:(t,e,s=!1)=>!t.out||s?e-(t.in||0):t.out-(t.in||0),toTrimmedPosition:(t,e,s)=>{const i=e-(t.in||0),r=P.getMaxSeekPosition(t,s),a=void 0!==s?r:i;return Math.min(i,a)},toProviderPosition:(t,e)=>e+(t.in||0),toTrimmedDuration:(t,e)=>(t.out?Math.min(t.out,e):e)-(t.in||0),isAtEnd:(t,e,s)=>{const i=P.getMaxSeekPosition(t,s);return P.toTrimmedPosition(t,e,s)>=i},validate:(t,e)=>{const s=t.in,i=t.out;if(void 0!==s){if(!Number.isFinite(s))throw new Error('"in" type');if(s<0)throw new Error("in < 0");if(Number.isFinite(e)&&s>=e)throw new Error("in >= duration")}if(void 0!==i){if(!Number.isFinite(i))throw new Error('"out" type');if(i<=0)throw new Error("out <= 0");if(s&&s>=i)throw new Error("in >= out");if(Number.isFinite(e)&&i>=e)throw new Error("out >= duration")}}};var R="1.10.0-rc.1";class k{constructor(){this.reset()}handleEvent({type:t}){t===d.LOAD&&this.reset()}reset(){}}const A={START:"Start",PLAY:"Play",PAUSE:"Pause",RESUME:"Resume",SEEK:"Seek",PROGRESS:"Progress",COMPLETE:"Complete",END:"End",ERROR:"Error"},C="Quartile1st",L="Quartile2nd",w="Quartile3rd",O="Complete",I="Beacon1M",D="Beacon10M",M="api-begin",N="api-end",B="vlt-begin",U="vlt-end",F="vst-begin",x="vst-end",K={UVP_API_READY_TIME:"uvp-app-load-time",UVP_VIDEO_LOAD_TIME:"uvp-video-load-time",UVP_VIDEO_START_TIME:"uvp-video-play-init"},Y=()=>({construction:[],srcChange:[],playCmd:[],readyState:[],playableState:[],playingState:[]}),V=()=>({construction:[M,B,F],srcChange:[],playCmd:[],readyState:[N],playableState:[U],playingState:[x]}),H=()=>({construction:[M,B],srcChange:[],playCmd:[F],readyState:[N],playableState:[U],playingState:[x]}),G=()=>({construction:[],srcChange:[],playCmd:[M,B,F],readyState:[N],playableState:[U],playingState:[x]}),W=()=>({construction:[],srcChange:[M,B],playCmd:[F],readyState:[N],playableState:[U],playingState:[x]}),q=()=>({construction:[],srcChange:[M,B,F],playCmd:[],readyState:[N],playableState:[U],playingState:[x]}),Q="critical",j="info";class X{constructor(t,e,s){this._callback=()=>{const t=Date.now()-this.expected;try{this.callback()}catch(t){console.error(t)}this.repeat&&0==(this.repeat-=1)||(this.expected+=this.interval,this.timeoutId=setTimeout(this._callback,Math.max(0,this.interval-t)))},this.callback=t,this.interval=e,this.repeat=s,this.expected=Date.now()+this.interval,this.timeoutId=setTimeout(this._callback,this.interval)}stop(){clearTimeout(this.timeoutId)}}class J extends k{constructor(t){super(),this.sendBeacon=e=>()=>t(e)}reset(){this._stopBeaconTimers()}handleEvent(t){switch(super.handleEvent(t),t.type){case d.COMPLETE:this._stopBeaconTimers();break;case d.METADATA:void 0!==t.data.isLive&&t.data.isLive&&0===this.timers.length&&this._startBeaconTimers();break;case d.ERROR:!0===t.data.fatal&&this._stopBeaconTimers()}}_startBeaconTimers(){this.timers.push(new X(this.sendBeacon(I),6e4,5)),this.timers.push(new X(this.sendBeacon(D),6e5))}_stopBeaconTimers(){if(this.timers)for(const t of this.timers)t.stop();this.timers=[]}}class z extends k{constructor(t){super(),this.callback=t}reset(){this.sendQuartiles=!1,this.remainingQuartiles=null,this.playing=!1,this.duration=null}handleEvent(t){var e,s;switch(super.handleEvent(t),c[t.type]&&(this.playing=t.type===c.PLAYING),t.type){case d.LOAD:this.reset();break;case d.METADATA:void 0===t.data.isLive||t.data.isLive||(this.sendQuartiles=!0);break;case d.TIMEUPDATE:if(this.sendQuartiles&&t.data.duration&&(this.remainingQuartiles&&this.duration===t.data.duration||(this.remainingQuartiles=this._createQuartiles(t.data.duration),this.duration=t.data.duration)),this.remainingQuartiles&&this.sendQuartiles&&this.playing){const e=this.remainingQuartiles.findIndex(({timestamp:e})=>e<t.data.position);if(-1!==e){const{progressType:t}=this.remainingQuartiles[e];this.callback(t),this.remainingQuartiles.splice(e,1)}}break;case d.SEEKED:if(this.sendQuartiles&&null!=(null===(e=t.data)||void 0===e?void 0:e.position)){const e=t.data.position;if(this.remainingQuartiles=this._createQuartiles(this.duration),this.remainingQuartiles){const t=this.remainingQuartiles.findIndex(({timestamp:t})=>t>e);t>0?this.remainingQuartiles.splice(0,t):-1==t&&(this.remainingQuartiles=[])}}break;case d.COMPLETE:this.remainingQuartiles=null;break;case d.ERROR:(null===(s=t.data)||void 0===s?void 0:s.fatal)&&(this.remainingQuartiles=null)}}_createQuartiles(t){const e=t/4;return[{timestamp:e,progressType:C},{timestamp:2*e,progressType:L},{timestamp:3*e,progressType:w},{timestamp:t-1,progressType:O}]}}class ${constructor(){this.state=$.STATE.STOPPED,this.totalTime=0}start(){this.state!==$.STATE.RUNNING&&(this.startTime=Date.now(),this.state=$.STATE.RUNNING)}stop(){this.state!==$.STATE.STOPPED&&(this.totalTime+=Date.now()-this.startTime,this.state=$.STATE.STOPPED)}reset(){this.startTime=Date.now(),this.totalTime=0}get value(){return this.state===$.STATE.RUNNING?this.totalTime+(Date.now()-this.startTime):this.totalTime}}$.STATE={RUNNING:"RUNNING",STOPPED:"STOPPED"};class Z extends k{reset(){this.rebufferStopwatch=new $,this.rebufferCount=0,this.bufferInProgress=!1,this.playableStateReached=!1,this.seekInProgress=!1}handleEvent(t){switch(super.handleEvent(t),t.type){case d.SEEK:this.seekInProgress=!0;break;case d.SEEKED:this.seekInProgress=!1;break;case c.BUFFERING:this.validRebufferState&&(this.rebufferCount+=1,this.rebufferStopwatch.start(),this.bufferInProgress=!0);break;case c.ERROR:!0===t.data.fatal&&(this.rebufferStopwatch.stop(),this.bufferInProgress=!1);break;case c.PAUSED:this.playableStateReached=!0;break;case c.PLAYING:this.playableStateReached=!0;case c.COMPLETE:this.rebufferStopwatch.stop(),this.bufferInProgress=!1}}get validRebufferState(){return!this.bufferInProgress&&this.playableStateReached&&!this.seekInProgress}get seconds(){return this.rebufferStopwatch.value/1e3}get count(){return this.rebufferCount}}class tt extends k{reset(){this.viewedStopwatch=new $,this.viewedWithSubsStopwatch=new $,this.lastSentTime=0,this.subsEnabled=!1}handleEvent(t){switch(super.handleEvent(t),t.type){case d.PLAYING:this._startStopwatches();break;case d.ERROR:if(!0!==t.data.fatal)break;case d.PAUSED:case d.COMPLETE:this._stopStopwatches();break;case d.METADATA:void 0!==t.data.subtitles&&(this.subsEnabled=!!t.data.subtitles,this.viewedStopwatch.state===$.STATE.RUNNING&&(this.subsEnabled?this.viewedWithSubsStopwatch.start():this.viewedWithSubsStopwatch.stop()))}}_resetStopwatches(){this.viewedStopwatch.reset(),this.viewedWithSubsStopwatch.reset()}_startStopwatches(){this.viewedStopwatch.start(),this.subsEnabled&&this.viewedWithSubsStopwatch.start()}_stopStopwatches(){this.viewedStopwatch.stop(),this.viewedWithSubsStopwatch.stop()}get totalSeconds(){return this.viewedStopwatch.value/1e3}get totalSecondsWithSubs(){return this.viewedWithSubsStopwatch.value/1e3}get current(){const t=this.viewedStopwatch.value,e=(t-this.lastSentTime)/1e3;return this.lastSentTime=t,e}}const et="Undefined";class st{static getProtocol(t,e){switch(t){case E:return/^https?:\/\//.test(e)?"WebFile":"LocalFile";case m:return"HLS";case v:return"DASH";default:return"Other"}}constructor(t){if(this.onBusEvent=t=>{if(this.disabled)return;const{qos:e,metadata:s}=this.options;if(e)for(const e of this.telemetryHelpers)e.handleEvent(t);const{type:i,data:r}=t;switch(i){case d.READY:this.sendComplete(!1),this.isFirstPlay=!0,this.sendSessionStart(),this.mark("readyState");break;case d.PAUSED:this.config.playableState.length>0&&this.mark("playableState"),this.playbackStartTime&&this.send(A.PAUSE);break;case d.PLAYING:this.sendPlay();break;case d.SEEKED:e&&this.playbackStartTime&&this.send(A.SEEK);break;case d.COMPLETE:this.sendComplete(!0),this.clearPerformanceMarks();break;case d.METADATA:if(r){const t=r.videoHeight||et,e=r.videoWidth||et;this.layout={videoHeight:t,videoWidth:e,videoDisplayHeight:r.displayHeight||et,videoDisplayWidth:r.displayWidth||et},(null==r?void 0:r.bitrate)>this.topBitrateValues.bitrate&&(this.topBitrateValues.bitrate=r.bitrate,this.topBitrateValues.videoHeight=t,this.topBitrateValues.videoWidth=e,this.topBitrateValues.timeToTopBitRate=this.viewTimer.totalSeconds),(null==r?void 0:r.bitrate)!=this.averageBitrateValues.lastBitrate&&this.calcAvgBitRateMetrics(r)}break;case d.ERROR:if(!1===r.fatal)return;this.playbackStartTime&&this.sendErrorEvent(r),this.clearPerformanceMarks()}},this.onBusCommand=({type:t})=>{switch(t){case d.PLAY:this.mark("playCmd"),this.sendSessionStart();break;case d.STOP:this.sendComplete(!1),this.clearPerformanceMarks()}},this.sendProgressEvent=t=>{this.options.qos&&this.player&&this.send(A.PROGRESS,{videoProgressType:t,duration:this.player.isLive?-1:this.player.duration})},this.instance=st.instances+=1,this.options=t,this.lastEventSent=null,this.prefix="".concat(t.isDev?"d":"p","::").concat(t.namespace),this.layout={},this.topBitrateValues={bitrate:0,timeToTopBitRate:0,videoHeight:0,videoWidth:0},this.averageBitrateValues={lastBitrate:0,lastBitrateReportTime:0,sumOfProductBitrateTime:0},this.props={...t.props},this.disabled=!t.qos&&!t.metadata,!this.disabled){if(t.qos){const e=t.props;e.src?e.autoplay?this.config=V():e.placeholder&&!e.preload?this.config=G():this.config=H():this.config=Y(),this.mark("construction"),this.viewTimer=new tt,this.rebufferTimer=new Z,this.quartileWatcher=new z(this.sendProgressEvent),this.beaconTimer=new J(this.sendProgressEvent),this.telemetryHelpers=[this.viewTimer,this.rebufferTimer,this.quartileWatcher,this.beaconTimer]}this.sessionInProgress=!1,this.sessionId=null,this.player=this.options.player}}get player(){return this.options.player}set player(t){this.disabled||(this.bindEventBus(!1),this.options.player=t,this.bindEventBus(!0))}onPropChange(t){if(this.disabled)return!0;const e=this.props;this.props={...t},this.options.qos&&e.src!==t.src&&(this.clearPerformanceMarks(),this.config=t.autoplay?q():W(),this.mark("srcChange"))}bindEventBus(t){const e=this.options.player;if(!e)return;e.eventBus&&(t?(e.eventBus.subscribe(this.onBusEvent),e.eventBus.subscribeToCommands(this.onBusCommand)):(e.eventBus.unsubscribe(this.onBusEvent,!0),e.eventBus.unsubscribe(this.onBusCommand,!0)))}calcAvgBitRateMetrics(t){const e=this.viewTimer.totalSeconds-this.averageBitrateValues.lastBitrateReportTime;this.averageBitrateValues.sumOfProductBitrateTime+=this.averageBitrateValues.lastBitrate*e,(null==t?void 0:t.bitrate)&&(this.averageBitrateValues.lastBitrate=t.bitrate),this.averageBitrateValues.lastBitrateReportTime=this.viewTimer.totalSeconds}async getCommonEventProperties(){var t,e;this.sessionId||(this.sessionId=await this.options.getSessionIdPromise());const s=this.options.metadata,i=R,r={videoPlayerId:"UVP",videoSessionId:this.sessionId,videoPlayerConfig:"".concat(this.prefix,"::").concat(null===(t=this.player)||void 0===t||null===(e=t.provider)||void 0===e?void 0:e.toLowerCase()),videoId:s&&s.videoId?s.videoId:et,videoPlayerVersion:i};if(this.options.qos){const t=(this.player?this.player.position:this.props.start)||0;Object.assign(r,{currentViewedTime:this.viewTimer.current,elapsedTime:t})}return r}getCommonCompleteAndErrorProperties(){const{qos:t,metadata:e}=this.options,s={isMuted:this.player.muted,...this.layout};return e&&Object.assign(s,{videoWindowMode:e.videoWindowMode||et,videoWindowPosition:e.videoWindowPosition||et}),t&&(this.calcAvgBitRateMetrics(null),Object.assign(s,{totalViewedTime:this.viewTimer.totalSeconds,totalViewedTimeWithSubs:this.viewTimer.totalSecondsWithSubs,rebufferRatio:this.rebufferTimer.seconds/this.viewTimer.totalSeconds,rebufferCount:this.rebufferTimer.count}),this.topBitrateValues.bitrate&&Object.assign(s,{timeToTopBitRate:this.topBitrateValues.timeToTopBitRate,videoHeight:this.topBitrateValues.videoHeight,videoWidth:this.topBitrateValues.videoWidth}),this.averageBitrateValues.sumOfProductBitrateTime&&this.viewTimer.totalSeconds&&Object.assign(s,{averageBitRate:this.averageBitrateValues.sumOfProductBitrateTime/1e3/this.viewTimer.totalSeconds})),s}sendSessionStart(){if(!this.player||this.sessionInProgress)return;const t=this.props,e=this.player.provider,s=this.options.metadata;this.isFirstPlay=!0;const i={isMuted:this.player.muted,videoUrl:t.src,autoStart:!!t.autoplay,streamType:this.player.isLive?"Live":"OnDemand",streamProtocol:st.getProtocol(e,t.src)};return s&&Object.assign(i,{videoWindowMode:s.videoWindowMode||et,videoGenre:s.videoGenre||et,maturitySystem:s.maturitySystem||et,maturityRating:s.maturityRating||et}),this.sessionInProgress=!0,this.sessionId=null,this.send(A.START,i)}sendPlay(){if(!this.player||!this.options.qos)return;const t=this.props,e=this.player.provider,s=!this.isFirstPlay||t.start;this.isFirstPlay=!1;const i={isMuted:this.player.muted,videoUrl:t.src,autoStart:!!t.autoplay,streamType:this.player.isLive?"Live":"OnDemand",streamProtocol:st.getProtocol(e,t.src),...this.layout};if(this.options.metadata&&Object.assign(i,{...this.options.metadata}),this.options.qos){const t=this.config.playableState.length+this.config.playingState.length;this.mark("playingState"),this.mark("playableState"),t>0&&(i.videoPlayerReadyTime=this.getTiming(K.UVP_API_READY_TIME,M,N),i.videoLoadTime=this.getTiming(K.UVP_VIDEO_LOAD_TIME,B,U),i.videoStartTime=this.getTiming(K.UVP_VIDEO_START_TIME,F,x),this.clearPerformanceMarks())}const r=s?"RESUME":"PLAY";return r!==this.lastEventSent?(this.playbackStartTime||(this.playbackStartTime=performance.now()),this.send(A[r],i)):void 0}sendComplete(t){if(!this.playbackStartTime||this.lastEventSent===A.COMPLETE)return;let e=this.getCommonCompleteAndErrorProperties();return e.videoCompleted=t,this.playbackStartTime=null,this.send(A.COMPLETE,e)}sendErrorEvent(t){if(this.lastEventSent===A.ERROR)return;const{errorCode:e,errorType:s}=t;let i=this.getCommonCompleteAndErrorProperties();i.videoCompleted=!1,i.errorCode=null==e?void 0:e.toString();const r=Object.keys(h).find(t=>h[t]===s);switch(i.errorType="".concat(s," - ").concat(r),s){case h.RESOURCES_STARVED:i.errorSeverity=j;break;default:i.errorSeverity=Q}return this.playbackStartTime=null,this.send(A.ERROR,i)}sendSessionEnd(){if(!this.sessionInProgress||this.lastEventSent===A.END)return;const t={totalViewedTime:this.viewTimer.totalSeconds,totalViewedTimeWithSubs:this.viewTimer.totalSecondsWithSubs};return this.sessionInProgress=!1,this.playbackStartTime=null,this.send(A.END,t)}async send(t,e){this.lastEventSent=t;const s={...await this.getCommonEventProperties(),...e,videoEventType:t};this.options.sendEvent(s)}getTiming(t,e,s){try{var i;this.measure(t,e,s);const r=performance.getEntriesByName(this.namespace(t));return null==r||null===(i=r[0])||void 0===i?void 0:i.duration}catch(t){console.error(t)}}namespace(t){return t&&"uvp-".concat(this.instance,":").concat(t)}mark(t){if(!this.options.qos)return;const e=this.config[t];for(;e&&e.length>0;)performance.mark(this.namespace(e.shift()))}measure(t,e,s){performance.measure(this.namespace(t),this.namespace(e),this.namespace(s))}clearPerformanceMarks(){this.options.qos&&(Object.values(K).map(t=>this.namespace(t)).forEach(t=>performance.clearMeasures(t)),this.config=Y())}destroy(){this.sendComplete(!1),this.sendSessionEnd(),this.bindEventBus(!1)}}st.instances=0;const it=["abort","canplay","canplaythrough","durationchange","emptied","encrypted","ended","error","interruptbegin","interruptend","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"];const rt={load:d.LOAD,ready:d.READY,playing:d.PLAYING,pause:d.PAUSED,ended:d.COMPLETE,waiting:d.BUFFERING,error:d.ERROR,timeupdate:d.TIMEUPDATE,metadata:d.METADATA,skipping:d.SKIPPING,seeking:d.SEEKING,seeked:d.SEEKED,canplaythrough:d.CAN_PLAY_THROUGH},at=[];var nt={add(t){at.push(t)},emit(t,e,s){at.forEach((function(i){try{const i=rt[e];i&&t.eventBus&&t.eventBus.emit(i,s)}catch(t){console.error('Exception caught emitting "'.concat(e,'" event to event bus'),s,t)}try{i(t,e,s)}catch(t){console.error('Exception caught emitting "'.concat(e,'" event to app layer'),s,t)}}))}};let ot=null,lt=!1;var dt={useSource(t){new t(this)},setAsControllerTarget(t,e){if(!lt){t=(e=!!t&&e)?t:null,lt=!0;try{ot&&ot!==t&&(ot.isControllerTarget=!1),ot=t,ot&&(ot.isControllerTarget=!0)}catch(t){console.error(t)}lt=!1}},onCommand(t){ot?ot.eventBus.dispatch(t.type,t.data):console.info("Ignoring command because no current controller target")}};const ct="undefined"==typeof window?global:window,ut=ct.document;function ht(t,e){return t.classList?t.classList.contains(e):!!t.className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))}function pt(t,e){if(!e)return;const s=e.split(" ");s.length>1?s.forEach(e=>pt(t,e)):ht(t,e)||(t.classList?t.classList.add(e):t.className+=" ".concat(e))}function mt(t,e){if(!e)return;const s=e.split(" ");if(s.length>1)s.forEach(e=>mt(t,e));else if(ht(t,e))if(t.classList)t.classList.remove(e);else{var i=new RegExp("(\\s|^)"+e+"(\\s|$)");t.className=t.className.replace(i," ")}}function vt(t,e,s){(s="boolean"==typeof s?s:!ht(t,e))?pt(t,e):mt(t,e)}function Et(t,e,s){const i=ut.createElement(t);return pt(i,e),s&&s.appendChild(i),i}function gt(t,e){return Et("div",t,e)}const yt=["src","type","lang","autoplay","muted","loop","volume","in","out","start","isLive","controls","fit","isControllerTarget","showControls","useFullscreenControls","coreResourceType","targetBitrate","drm","audioPassThrough","systemSubtitles","telemetry","isDev"],_t=ct.navigator.userAgent.indexOf("PlayStation")>=0;const bt=13,Tt=27,ft=37,St=38,Pt=39,Rt=40,kt=179,At=135,Ct=178,Lt=133,wt=134,Ot=139,It=217;let Dt=[],Mt={},Nt=!1;const Bt=function(){const t=(new Date).valueOf(),e=Math.pow(2,32);let s=0;return function(){return t+"_"+(s<e?s++:0)}}();window.msdk?Nt=!0:window.addEventListener("loadedmsdk",()=>{Nt=!0,Ft.sendQueued()});const Ut=t=>{let e;if(t.data){try{e=JSON.parse(t.data)}catch(t){return}e.broadcast||Ft.handleCallbackEvent(e)}};document.addEventListener("message",Ut),window.addEventListener("message",Ut);class Ft{static send(t,e){const s=window.postMessageNative||window.postMessage;let i={id:Bt(),api:t,args:e},r={reject:null,resolve:null},a=new Promise((t,e)=>{r.resolve=t,r.reject=e});return Mt[i.id]=r,Nt?s(JSON.stringify(i),"*"):Dt.push(s.bind(this,JSON.stringify(i),"*")),a}static handleCallbackEvent(t){const e=Mt[t.id];e&&(delete Mt[t.id],t.success?e.resolve(t.result):e.reject(t.result))}static sendQueued(){Dt.forEach(t=>t()),Dt.length=0}}const xt=1;var Kt;let Yt=!1;function Vt(){var t;null===(t=ct.msdk)||void 0===t||t.system.getTextToSpeechSettings().then(t=>{Yt=t.enabled})}Vt(),null===(Kt=ct.msdk)||void 0===Kt||Kt.addEventListener("onForeground",()=>Vt());const Ht=["msgid_live","msgid_sr_player_controls","msgid_sr_up_down_buttons_to_move","msgid_sr_pause","msgid_sr_focused_item","msgid_sr_fast_fwd_reverse","msgid_sr_resume","msgid_sr_skipped_forward_variable","msgid_sr_var_seconds","msgid_sr_onemin","msgid_sr_one_min_var_sec","msgid_sr_min_sec_var","msgid_sr_var_min","msgid_sr_skipped_reverse_variable","msgid_sr_press_circle_back","msgid_sr_video_options_menu","msgid_sr_closed_captions_menu","msgid_sr_audio_menu","msgid_audio","msgid_video_options","msgid_closed_captions","msgid_captions","msgid_an_error_has_occurred","msgid_off","msgid_none","msgid_sr_selected","msgid_sr_not_selected","msgid_sr_button","msgid_sr_list_items","msgid_sr_video_over","msgid_sr_paused_media","msgid_sr_resumed","msgid_sr_loading","msgid_sr_play_media","msgid_sr_open_video_controls","msgid_number_channels"];let Gt={};var Wt;function qt(t){return Ht.includes(t)||console.error('Translation msgid "'.concat(t,'" must be added to TRANSLATION_STRINGS')),Gt[t]||t}function Qt(t,e=!0){if(!Yt)return;e&&function(){if(!Yt)return;ct.speechSynthesis.speaking&&ct.speechSynthesis.cancel()}();const s=new ct.SpeechSynthesisUtterance(t);ct.speechSynthesis.speak(s)}function jt(t,e){let s=t;for(const t in e)s=s.replace("%".concat(t,"%"),e[t]);return s}(Wt=Ht,Ft.send("Localization.getTranslations",Wt)).then(t=>Gt=t);const Xt=!0,Jt=null;class zt extends class{get isProspero(){return _t}constructor(t,s){this.destroyed=!1,this.createAdapterAf=null,this.rootStructure=null,this.adapter=null,this.state=null,this._createAdapter=this._createAdapter.bind(this),this.eventBus=new l,this.eventBus.subscribe(this._onBusEvent.bind(this)),this.eventBus.subscribeToCommands(this._onControlCommand.bind(this)),this.el="string"==typeof t?ct.document.querySelector(t):t,pt(this.el,"sce-uvp"),this.destroyed=!1;const i=gt("sce-uvp-inner-container"),r=gt("sce-uvp-player-container",i);let a;e.get("Controls")&&(a=gt("sce-uvp-controls-container",i)),this.el.appendChild(i),this.rootStructure={playerContainer:r,controlsContainer:a,innerContainer:i},this.setOptions(s)}get initialState(){return{isLiveFlagLocked:!1,canSkip:!1}}setOptions(t){let e=!this.state;if(!e)for(const s of _){const i=t[s];if(i!==this.state[s]&&(void 0!==i||!1!==this.state[s])){e=!0;break}}if(e&&(this.state=this.initialState),Object.assign(this,t),e)try{this._createAdapter()}catch(t){console.error(t)}}get src(){return this.state.src}set src(t){this._changeCriticalOption("src",t)}get provider(){return this.adapter?this.adapter.provider:null}get drm(){return this.state.drm}set drm(t){this._changeCriticalOption("drm",t)}get type(){return this.state.type}set type(t){this._changeCriticalOption("type",t)}get in(){return this.state.in}set in(t){this._changeCriticalOption("in",t)}get out(){return this.state.out}set out(t){this._changeCriticalOption("out",t)}get coreResourceType(){return this.state.coreResourceType}set coreResourceType(t){this._changeCriticalOption("coreResourceType",t)}get targetBitrate(){return this.state.targetBitrate}set targetBitrate(t){this.state.targetBitrate=t}get audioPassThrough(){return this.state.audioPassThrough}set audioPassThrough(t){this._changeCriticalOption("audioPassThrough",t)}get autoplay(){return this.state.autoplay}set autoplay(t){this.state.autoplay=t}get volume(){return parseFloat(this.state.volume||1)}set volume(t){this.state.volume=t,this.adapter&&(this.adapter.volume=t)}get muted(){return this.state.muted}set muted(t){t=this.state.muted=!!t,this.adapter&&(this.adapter.muted=t)}get loop(){return this.state.loop}set loop(t){t=this.state.loop=!!t,this.adapter&&(this.adapter.loop=t)}set systemSubtitles(t){this.state.systemSubtitles=!!t,this.adapter&&(this.adapter.systemSubtitles=this.state.systemSubtitles)}get systemSubtitles(){return this.state.systemSubtitles}get start(){return parseFloat(this.state.start||0)}set start(t){this.state.start=t}get fit(){return this.state.fit}set fit(t){if(!["none","contain","cover","stretch","fill"].includes(t=t||"contain"))throw new Error('invalid fit setting "'.concat(t,'"'));this.state.fit=t||void 0,vt(this.el,"sce-uvp-fit-cover","cover"===t),vt(this.el,"sce-uvp-fit-stretch","stretch"===t||"fill"===t)}play(){this.eventBus.dispatch(d.PLAY)}pause(){this.eventBus.dispatch(d.PAUSE)}get paused(){return!this.adapter||this.playbackState===c.PAUSED}stop(){this.pause(),this.position=0}set position(t){this.adapter.position=t}seek(t){this.position=t}get position(){return this.adapter?this.adapter.position:null}set subtitles(t){this.adapter.subtitles=t}get subtitles(){return this.adapter?this.adapter.subtitles:null}get subtitleTracks(){return this.adapter?this.adapter.subtitleTracks:null}set audio(t){this.adapter.audio=t}get audio(){return this.adapter?this.adapter.audio:null}get audioTracks(){return this.adapter?this.adapter.audioTracks:null}get duration(){return this.adapter?this.adapter.duration:null}set duration(t){throw new Error("duration is read-only")}get isLive(){return this.state.isLive}get canSkip(){return this.state.canSkip}get minPosition(){return this.adapter?this.adapter.minPosition:null}get maxPosition(){return this.adapter?this.adapter.maxPosition:null}set isLive(t){!this.state.isLiveFlagLocked||this.createAdapterAf||t?this.state.isLive=!!t:console.warn("".concat("SceUvp >> ","can't un-set isLive flag on live stream"))}set isControllerTarget(t){this.state.isControllerTarget=!!t,dt.setAsControllerTarget(this,t)}get isControllerTarget(){return!!this.state.isControllerTarget}emit(t,e){nt.emit(this,t,e)}_onBusEvent(t){switch(t.type){case d.METADATA:void 0!==t.data.isLive&&(this.state.isLive=t.data.isLive,this.state.isLiveFlagLocked=!0),void 0!==t.data.canSkip&&(this.state.canSkip=t.data.canSkip)}c[t.type]&&(this.playbackState=t.type)}_onControlCommand(t){const{type:e,data:s}=t;switch(e){case d.OPTIONS:this.setOptions(s);break;case d.PLAY:this.adapter.play();break;case d.PAUSE:this.adapter.pause();break;case d.STOP:this.stop();break;case d.SEEK:this.position=parseFloat(s.position)||0}}async _createAdapter(){if(cancelAnimationFrame(this.createAdapterAf),delete this.createAdapterAf,!this.state.src)return this._destroyTelemetry(),null;const t=r.get(this.state.src,this.state.type),e=this.adapter=new t(this);this._initTelemetry(),await e.render(this.rootStructure.playerContainer),yt.forEach(t=>this[t]=this[t])}_changeCriticalOption(t,e){this.state[t]!==e&&_.includes(t)&&(this.state[t]=e,cancelAnimationFrame(this.createAdapterAf),this.createAdapterAf=requestAnimationFrame(this._createAdapter),this.adapter&&this.adapter.unload(),this.adapter=null)}_initTelemetry(){}_destroyTelemetry(){}unload(){this.destroyed=!0,this.isControllerTarget=!1,this.adapter&&this.adapter.unload(),this.el&&(this.el.innerHTML="",mt(this.el,"sce-uvp"))}}{static async getSessionIdPromise(){let t;try{t=(await ct.msdk.psn.getAccountInfo()).accountId}catch(e){t="".concat(1e11*Math.random()),console.error('[UVP] failed to get account ID - using "'.concat(t,'" ').concat(e))}const e="".concat(t).concat(Date.now()).length,s=new Int16Array(new ArrayBuffer(2*e));for(let i=0;i<e;i+=1)s[i]=t.charCodeAt(i);const i=await crypto.subtle.digest("SHA-256",s),r=btoa(String.fromCharCode.apply(null,new Uint8Array(i)));return"uvpweb-".concat(r)}constructor(t,e){super(t,e),this._constructing=!0,this._playing=!1,this._hideControlsDelay=void 0,this.options=e,this.focused=!1;try{this.controlsComponent=null,e.controls&&void 0===e.showControls&&(e.showControls=!0),this._onKeyInputEvent=this._onKeyInputEvent.bind(this),se(this,!0)}catch(t){console.error(t)}const s=gt("sce-uvp-feedback-indicator",this.rootStructure.innerContainer);this.seekTime=gt("sce-uvp-feedback-indicator-time",s),this.el.addEventListener("focus",()=>{this.focused=!0,Qt(qt("msgid_sr_player_controls")),Qt(qt("msgid_sr_up_down_buttons_to_move"),!1),Qt(qt("msgid_sr_pause"),!1),Qt(qt("msgid_sr_focused_item"),!1),Qt(qt("msgid_sr_fast_fwd_reverse"),!1)}),this.el.addEventListener("blur",()=>{this.focused=!1}),this.playbackPending=!1,this._constructing=!1,this.skipping=!1}get version(){return R}get initialState(){return Object.assign({coreResourceType:u,audioPassThrough:!0},super.initialState)}get src(){return super.src}set src(t){const e=t===super.src;super.src=t,e&&this._telemetry&&this._telemetry.onPropChange(this.state)}get isLive(){return super.isLive}set isLive(t){t=!!t,this.skipping&&this.isLive!==t&&this._skip.abort(),super.isLive=t}focus(){this.el.focus()}get currentTime(){return this.position}set currentTime(t){this.position=t}get telemetry(){return this._telemetryConfig=$t(this.state.telemetry,this._telemetryConfig),this._telemetryConfig}set telemetry(t){const e=$t(t,this._telemetryConfig);this._changeCriticalOption("telemetry",e),this._telemetryConfig=e}get isDev(){return this.state.isDev}set isDev(t){this._changeCriticalOption("isDev",t)}set controls(t){t=!!t,this.state.controls!==t&&(this.state.controls=t,this._constructing||Zt(this))}get controls(){return this.state.controls}get showControls(){return this.state.showControls}set showControls(t){clearTimeout(this._autohideFocusTimeout);const e=this.state.showControls!=t;this.state.showControls=!!t,vt(this.el,"sce-uvp-hide-controls",!t),t?ee(this):e&&(this._autohideFocusTimeout=setTimeout(()=>{this.focus()},400))}get useFullscreenControls(){return this.state.useFullscreenControls}set useFullscreenControls(t){this.state.useFullscreenControls=!!t,vt(this.el,"is-sce-uvp-fullscreen",!!t),t?this.focus():this.showControls=!!this.controls,ee(this)}get metadata(){return this.state.metadata}set metadata(t){this.state.metadata=t,this.controlsComponent&&(this.controlsComponent.metadata=t)}togglePlayPause(){this[this._playing?"pause":"play"]()}skipForward(){re(this,d.SKIP_FWD)}skipBack(){re(this,d.SKIP_BACK)}on(t,e){this.toggleListener(t,e,!0)}off(t,e){this.toggleListener(t,e,!1)}once(t,e){const s=(...i)=>{this.off(t,s),e.apply(this,i)};this.toggleListener(t,s,!0)}triggerEvent(t,e={},s=!1){const i=new CustomEvent(t,{bubbles:s,detail:Object.assign({},e,this)});this.el.dispatchEvent(i)}toggleListener(t,e,s=!1){(Array.isArray(t)?t:t.split(" ")).forEach(t=>{this.el[s?"addEventListener":"removeEventListener"](t,e)})}_onBusEvent(t){switch(super._onBusEvent.apply(this,arguments),t.type){case d.ERROR:if(!t.data.fatal)return;case d.COMPLETE:case d.PAUSED:this._playing=!1,this.showControls=!0}switch(t.type){case d.SKIPPING:if(!this.skipping&&t.data&&ie(this.el),this.skipping=!!t.data,t.data&&(this.seekTime.innerHTML=b.format(Math.abs(t.data.deltaSec))),this.skipping){const e=t.data.deltaSign>0;vt(this.el,"sce-uvp-feedback-indicator-skip-fwd",e),vt(this.el,"sce-uvp-feedback-indicator-skip-back",!e)}break;case d.PLAYING:this._playing=!0,this.playbackPending&&(this.useFullscreenControls&&Qt(qt("msgid_sr_open_video_controls")),this.playbackPending=!1);break;case d.BUFFERING:this._playing=!0;break;case d.LOAD:ie(this.el),this._playing=!1,this.playbackPending=!0;break;case d.COMPLETE:ie(this.el),Qt(qt("msgid_sr_video_over"))}}_getTimeString(t){let e,s=Math.abs(t),i=Math.floor(s/60),r=Math.floor(s-60*i);return e=0==i?jt(qt("msgid_sr_var_seconds"),{num:r.toString()}):1==i?0==r?qt("msgid_sr_onemin"):jt(qt("msgid_sr_one_min_var_sec"),{num:r.toString()}):0==r?jt(qt("msgid_sr_var_min"),{num:i.toString()}):jt(qt("msgid_sr_min_sec_var"),{num1:i.toString(),num2:r.toString()}),e}_onControlCommand(t){let e,s,i;super._onControlCommand.apply(this,arguments);const{type:r,data:a}=t;switch(r){case d.SKIP_FWD:this.showControls=!0,this.skipForward();break;case d.SKIP_BACK:this.showControls=!0,this.skipBack();break;case d.SKIP_APPLY:i=a.deltaSign>0?"sce-uvp-feedback-indicator-skip-apply-fwd":"sce-uvp-feedback-indicator-skip-apply-back",vt(this.el,i,!0),this.seek(a.position),e=this._getTimeString(a.deltaSec),s=qt(a.deltaSign>0?"msgid_sr_skipped_forward_variable":"msgid_sr_skipped_reverse_variable"),Qt(jt(s,{skiplength:e})),Qt(qt("msgid_sr_pause"),!1),Qt(qt("msgid_sr_focused_item"),!1);break;case d.PLAY:this.showControls=!0,(null==a?void 0:a.silent)||(ie(this.el),vt(this.el,"sce-uvp-feedback-indicator-playing",!0),Qt(qt(this.paused?"msgid_sr_resumed":"msgid_sr_play_media")),Qt(qt("msgid_sr_pause"),!1),Qt(qt("msgid_sr_focused_item"),!1));break;case d.PAUSE:this.showControls=!0,(null==a?void 0:a.silent)||(ie(this.el),vt(this.el,"sce-uvp-feedback-indicator-pausing",!0),Qt(qt("msgid_sr_paused_media")),Qt(qt("msgid_sr_resume"),!1),Qt(qt("msgid_sr_focused_item"),!1));break;case d.PLAY_PAUSE:this.togglePlayPause(),this.paused?(this.showControls=!0,Qt(qt("msgid_sr_resumed"),!1),Qt(qt("msgid_sr_pause"),!1),Qt(qt("msgid_sr_focused_item"),!1)):(Qt(qt("msgid_sr_paused_media"),!1),Qt(qt("msgid_sr_resume"),!1),Qt(qt("msgid_sr_focused_item"),!1));break;case d.STOP:this.showControls=!0}}_onKeyInputEvent(t){const e=t.keyCode;if(t.target!==this.el)return;let s=!1;if(e===bt&&(this.togglePlayPause(),s=!0),this.useFullscreenControls){switch(s=!0,t.keyCode){case ft:this.skipBack();break;case Pt:this.skipForward();break;case Tt:this.showControls?this.showControls=!1:s=!1;break;case St:this.showControls?Qt(""):(Qt(qt("msgid_sr_player_controls")),Qt(qt("msgid_sr_up_down_buttons_to_move"),!1),Qt(qt("msgid_sr_pause"),!1),Qt(qt("msgid_sr_focused_item"),!1),Qt(qt("msgid_sr_fast_fwd_reverse"),!1)),this.showControls=!this.showControls;break;case Rt:this.showControls?this.controlsComponent.menu.focus():this.showControls=!0;break;default:s=!1}s&&(t.preventDefault(),t.stopPropagation())}}async _createAdapter(){var t,e,s,i;this.emit("load"),null===(t=this._skip)||void 0===t||t.abort(),await super._createAdapter();const r=null!==(e=null===(s=this.options)||void 0===s||null===(i=s.controls)||void 0===i?void 0:i.skipSec)&&void 0!==e?e:void 0;this._skip=S(this,r),this.state.src?Zt(this):this.controlsComponent&&this.controlsComponent.unload()}_initTelemetry(){this._destroyTelemetry();const t=this.telemetry;this._telemetry=new st({namespace:"web",isDev:!!this.state.isDev,props:this.state,player:this,qos:t.qos,metadata:t.metadata,getSessionIdPromise:zt.getSessionIdPromise,sendEvent:t=>{console.info("[UVP-TELEMETRY]",t.videoEventType,t),((t,e)=>{Ft.send("Telemetry.send",{eventType:t,payload:e})})(xt,t)}})}_destroyTelemetry(){this._telemetry&&this._telemetry.destroy(),this._telemetry=null}_render(){!this.controlsComponent&&Zt(this),this.el.hasAttribute("tabIndex")||(this.el.tabIndex=0)}unload(){super.unload(),this._destroyTelemetry(),this.controlsComponent&&se(this,!1)}}function $t(t,e){const s="object"==typeof t&&t,i=s&&void 0!==s.qos?s.qos:Xt,r=s&&void 0!==s.metadata?s.metadata:Jt;return e&&i===e.qos&&r===e.metadata?e:{qos:i,metadata:r}}function Zt(t){const s=e.get("Controls");if(!s||t.destroyed)return;const i=t.rootStructure.controlsContainer,r=t.controlsComponent;r&&(r.unload(),t.controlsComponent=null),i.innerHTML="",te(t)&&(t.controlsComponent=new s(t,i),i.querySelectorAll(".sce-uvp-icon-button").forEach(e=>{e.addEventListener("focus",()=>{t.focused=!0,clearTimeout(t._hideControlsDelay)}),e.addEventListener("blur",()=>{t.focused=!1})}))}const te=t=>!!(t.controls&&t.adapter&&e.get("Controls"));function ee(t){clearTimeout(t._hideControlsDelay),t.state.showControls&&t.useFullscreenControls&&(t._hideControlsDelay=setTimeout(()=>{[d.PLAYING,d.BUFFERING].includes(t.playbackState)&&(t.showControls=!1)},3e3))}function se(t,e){t.el[e?"addEventListener":"removeEventListener"]("keydown",t._onKeyInputEvent)}function ie(t){vt(t,"sce-uvp-feedback-indicator-playing sce-uvp-feedback-indicator-pausing sce-uvp-feedback-indicator-skip-fwd sce-uvp-feedback-indicator-skip-back sce-uvp-feedback-indicator-skip-apply-fwd sce-uvp-feedback-indicator-skip-apply-back",!1)}function re(t,e){t.useFullscreenControls&&(t.showControls=!0),t.canSkip&&t._skip(e)}const ae=["durationchange","timeupdate","playing","waiting","pause","error"];class ne{constructor(t,e){const s="string"==typeof e?ct.document.querySelector(e):e;this.uvp=t,this.primaryTextEl=this.secondaryTextEl=this.timecodeElements=this.playhead=this.playPause=null,this.duration=this.currentTimeFloat=this.currentTimeSec=0,this.skipping=!1,this.videoOptionsFirstFocus=!0,this.el=gt("sce-uvp-controls",s);const i=t.eventBus.dispatch.bind(t.eventBus);this.onPlayClicked=()=>i(d.PLAY),this.onPauseClicked=()=>i(d.PAUSE),this.onControlEvent=t=>function(t,e){const{type:s,data:i}=e;switch(s){case d.SKIPPING:!function(t,e){t.skipping=!!e,t.skipping&&(vt(t.el,"is-sce-uvp-playing",!1),me(t,e.duration,e.targetTime))}(t,i);break;case d.METADATA:void 0!==i.isLive&&function(t,e){vt(t.el,"is-sce-uvp-live",!!e),e?me(t,t.uvp.duration,t.uvp.currentTime):de(t,!0);ve(t)}(t,i.isLive)}}(this,t),this.onMediaEvent=t=>function(t,e){switch(e.type){case"timeupdate":case"durationchange":t.skipping||de(t),he(t);break;case"playing":mt(t.uvp.el,"is-sce-uvp-loading"),ue(t,!0);break;case"waiting":pt(t.uvp.el,"is-sce-uvp-loading"),ue(t,!0);break;case"pause":mt(t.uvp.el,"is-sce-uvp-loading"),ue(t,!1);break;case"error":e.detail.fatal&&(mt(t.uvp.el,"is-sce-uvp-loading"),ue(t,!1))}}(this,t),function(t){const e=gt("sce-uvp-bg",t.el);t.primaryTextEl=Et("h1","",e),t.secondaryTextEl=Et("h2","",e),function(t,e){t.timeline=gt("sce-uvp-timeline",e);const s=t.timecodeElements={lhs:{},rhs:{}},i=t.timelineBox=gt("sce-uvp-timeline-box",t.timeline),r=t.lhsTimecode=gt("sce-uvp-lhs-timecode timecode",i),a=t.timelineOuter=gt("sce-uvp-timeline-outer",i),n=t.rhsTimecode=gt("sce-uvp-rhs-timecode timecode",i),o=t.timelineInner=gt("sce-uvp-timeline-inner",a),l=t.playheadBox=gt("sce-uvp-timeline-playhead-box",o),d=t.playPause=gt("sce-uvp-timeline-playpause",o);le(r,s.lhs,"lhs"),le(n,s.rhs,"rhs"),t.playhead=gt("sce-uvp-playhead",l),t.playingBtn=gt("sce-uvp-playing",d),t.pausingBtn=gt("sce-uvp-pausing",d),de(t,!0)}(t,e),function(t,e){const s=gt("sce-uvp-menu",e);s.innerHTML='\n    <button class="sce-uvp-icon-button sce-uvp-quality-adjust"></button>\n    <div class="sce-uvp-menu-list">\n      <ul>\n        <li>\n          <button class="sce-uvp-menu-audio"></button>\n        </li>\n        <li>\n          <button class="sce-uvp-menu-subtitles"></button>\n        </li>\n      </ul>\n    </div>\n    <div class="sce-uvp-menu-values"><ul></ul></div>\n  ';let i=s.querySelector(".sce-uvp-menu-values ul"),r=t.menu=s.querySelector("button"),a=s.querySelector(".sce-uvp-menu-audio"),n=s.querySelector(".sce-uvp-menu-subtitles");function o(){var e;const s=t.uvp;let i=null===(e=s.audioTracks)||void 0===e?void 0:e.find(t=>t.id===s.audio);i?(a.parentElement.hidden=!1,a.innerHTML="".concat(qt("msgid_audio")," <span>").concat(i?i.name:qt("msgid_none"),"</span>")):a.parentElement.hidden=!0,n.innerHTML="".concat(qt("msgid_captions")," <span>").concat(ge(t),"</span>")}function l(t,e,s,i){return'\n      <li class="'.concat(t&&"sce-uvp-menu-selected",'">\n        <button\n          data-label="').concat(i,'"\n          data-field="').concat(e,'"\n          data-value="').concat(s,'"\n          data-selected="').concat(t,'"\n        >\n          ').concat(t?"&check;":"&nbsp;&nbsp;&nbsp;"," ").concat(i,"\n        </button>\n      </li>\n    ")}function d(e,a,n){switch(n.preventDefault(),n.stopPropagation(),n.keyCode){case bt:!function(e,s){let r,a=t.uvp[e].length;r=t.uvp[e].map(e=>l(t.uvp[s]===e.id,s,e.id,e.name)).join(""),"subtitles"==s&&(r=l(!1===t.uvp[s],"subtitles",!1,qt("msgid_off"))+r,a+=1),Qt("".concat(qt("subtitles"==s?"msgid_sr_closed_captions_menu":"msgid_sr_audio_menu"))),Qt(qt("msgid_sr_up_down_buttons_to_move"),!1);let n=!0;i.innerHTML=r,i.querySelectorAll("button","subtitles").forEach(e=>{e.addEventListener("focus",()=>{let t="".concat(e.getAttribute("data-label"),", ").concat("true"==e.getAttribute("data-selected")?qt("msgid_sr_selected"):qt("msgid_sr_not_selected")),i="false"===e.getAttribute("data-value")?-1:parseInt(e.getAttribute("data-value"));i="subtitles"==s?i+2:i+1,Qt(t,!n),n=!1,Qt(qt("msgid_sr_focused_item"),!1),Qt(jt(qt("msgid_sr_list_items"),{currentnum:"".concat(i),totalnum:"".concat(a)}),!1),Qt(qt("msgid_sr_press_circle_back"),!1)}),e.addEventListener("keydown",e=>{e.keyCode==bt&&(t.videoOptionsFirstFocus=!0,Qt(qt("msgid_sr_selected")))})}),i.querySelector('button[data-value="'.concat(t.uvp[s],'"')).focus()}(e,a);break;case Tt:s.classList.remove("sce-uvp-menu-open"),i.innerHTML="",r.focus();break;case St:Ee(n.target,!1);break;case Rt:Ee(n.target,!0)}}a.addEventListener("focus",()=>{var e;let s=null===(e=t.uvp.audioTracks)||void 0===e?void 0:e.find(e=>e.id===t.uvp.audio);Qt(qt("msgid_audio"),!t.videoOptionsFirstFocus),Qt(s?s.name:qt("msgid_none"),!1),Qt(qt("msgid_sr_focused_item"),!1),Qt(jt(qt("msgid_sr_list_items"),{currentnum:"1",totalnum:"2"}),!1),Qt(qt("msgid_sr_press_circle_back"),!1),t.videoOptionsFirstFocus=!1}),n.addEventListener("focus",()=>{Qt(qt("msgid_closed_captions"),!t.videoOptionsFirstFocus),Qt(ge(t),!1),Qt(qt("msgid_sr_focused_item"),!1),Qt(jt(qt("msgid_sr_list_items"),{currentnum:a.parentElement.hidden?"1":"2",totalnum:a.parentElement.hidden?"1":"2"}),!1),Qt(qt("msgid_sr_press_circle_back"),!1),t.videoOptionsFirstFocus=!1}),r.addEventListener("focus",()=>{Qt(qt("msgid_video_options")),Qt(qt("msgid_sr_focused_item"),!1)}),r.addEventListener("keydown",e=>{switch(e.preventDefault(),e.stopPropagation(),e.keyCode){case bt:Qt(qt("msgid_sr_video_options_menu")),Qt(qt("msgid_sr_up_down_buttons_to_move"),!1),s.classList.add("sce-uvp-menu-open"),o(),s.querySelectorAll(".sce-uvp-menu-list li:not([hidden]) button")[0].focus();break;case Tt:s.classList.remove("sce-uvp-menu-open");case St:t.uvp.useFullscreenControls=!0}}),s.querySelector(".sce-uvp-menu-audio").addEventListener("keydown",d.bind(this,"audioTracks","audio")),s.querySelector(".sce-uvp-menu-subtitles").addEventListener("keydown",d.bind(this,"subtitleTracks","subtitles")),i.addEventListener("keydown",e=>{let r=e.target.dataset;switch(e.stopPropagation(),e.preventDefault(),e.keyCode){case bt:t.uvp[r.field]="false"!==r.value&&parseInt(r.value);let a=i.querySelector('button[data-value="'.concat(t.uvp[r.field],'"'));Qt("".concat(a.getAttribute("data-label"))+qt("msgid_sr_selected")),o();case Tt:i.innerHTML="",s.querySelector(".sce-uvp-menu-".concat(r.field)).focus();break;case St:Ee(e.target,!1);break;case Rt:Ee(e.target,!0)}})}(t,e),t.rendered=!0,oe(t,!0),pt(t.uvp.el,"is-sce-uvp-loading"),ce(t)}(this)}set metadata(t){ce(this)}unload(){this.rendered=!1,oe(this,!1)}}function oe(t,e){const s=e?"addEventListener":"removeEventListener";t.playingBtn[s]("click",t.onPauseClicked),t.pausingBtn[s]("click",t.onPlayClicked),t.uvp[e?"on":"off"](ae,t.onMediaEvent),t.uvp.eventBus[e?"subscribe":"unsubscribe"](t.onControlEvent)}function le(t,e,s){let i='\n    <span class="sce-uvp-time sce-uvp-time-'.concat(s,'">\n      <span class="sce-uvp-timecode"></span>\n    </span>\n  ');"rhs"===s&&(i+='\n      <span class="sce-uvp-live">\n        <span class="sce-uvp-live-dot"></span>\n        '.concat(qt("msgid_live"),"\n      </span>\n    ")),t.innerHTML=i,e.timeStr=t.querySelector(".sce-uvp-timecode")}async function de(t,e){const s=t.uvp;e=e||!t.currentTimeFloat||!t.currentTimeSec;const i=s.currentTime,r=Math.abs(i-(t.currentTimeFloat||0)),a=Math.abs(i-(t.currentTimeSec||0));if((e||a>=1)&&(t.currentTimeSec=a,pe(t,"lhs",i)),ve(t),t.skipping)return;const n=r/(t.duration||Math.max(1,r));(e||n>.001)&&(t.currentTimeFloat=i,me(t,t.uvp.duration,t.uvp.currentTime))}function ce(t){t.rendered&&(ue(t,!t.uvp.paused),function(t){const e=t.uvp.metadata;t.primaryTextEl.innerHTML=e&&e.primaryText||"",t.secondaryTextEl.innerHTML=e&&e.secondaryText||""}(t),he(t))}function ue(t,e){vt(t.el,"is-sce-uvp-playing",e)}async function he(t){const e=t.uvp;t.duration!==e.duration&&(t.currentTimeSec=t.currentTimeFloat=void 0,pe(t,"lhs",e.currentTime),pe(t,"rhs",e.duration),me(t,e.duration,e.currentTime),t.duration=e.duration)}function pe(t,e,s){t.timecodeElements[e].timeStr.innerHTML=b.format(s)}function me(t,e,s){const i=e?Math.min(100*(s||0)/(e||Math.max(s||0,1)),100):0,r="".concat(i,"%");t.playPause.style.left=r,t.playhead.style.width=r}function ve(t){const e=t.uvp.isLive&&Math.abs(t.duration-t.currentTimeFloat)<3;vt(t.el,"is-sce-uvp-at-live-point",e)}function Ee(t,e){let s=t.closest("li");s=e?s.nextElementSibling||s.parentNode.firstElementChild:s.previousElementSibling||s.parentNode.lastElementChild,s.querySelector("button").focus()}function ge(t){const e=t.uvp;if(!e.subtitleTracks)return qt("msgid_none");const s=e.subtitleTracks.find(t=>t.id===e.subtitles);return s?s.name:qt("msgid_off")}e.set("Controls",ne);const ye={[kt]:d.PLAY,[At]:d.PAUSE,[It]:d.PLAY_PAUSE,[wt]:d.SKIP_FWD,[Lt]:d.SKIP_BACK,[Ct]:d.STOP,[Ot]:d.CLOSED_CAPTIONS};let _e;function be(t){const e=t.keyCode,s=ye[e];s&&(t.stopPropagation(),_e.onCommand({type:s,data:!0}))}class Te extends class{constructor(t,e){this.uvp=t,this.config=e,this.metadata={},this.seekingToSec=null,this.throttledErrors={},this._handleTimeupdate=this._handleTimeupdate.bind(this)}get provider(){return this.constructor.id}get isLive(){return!!this.uvp.isLive}get duration(){return this.isLive?this.providerDuration:P.toTrimmedDuration(this.uvp,this.providerDuration)}get providerDuration(){if(this.isLive)return 1;throw new Error('implement "get providerDuration()" on adapter for VOD')}get position(){return this.isLive?this.providerPosition:P.toTrimmedPosition(this.uvp,this.providerPosition)}get providerPosition(){if(this.isLive)return 1;throw new Error('implement "get providerPosition()" on adapter for VOD')}get minPosition(){return P.getMinSeekPosition(this.uvp)}get maxPosition(){return P.getMaxSeekPosition(this.uvp,this.providerDuration)}get isAtEnd(){return P.isAtEnd(this.uvp,this.providerPosition,this.providerDuration)}play(){throw new Error('implement "play()" on adapter')}pause(){throw new Error('implement "pause()" on adapter')}seek(){throw new Error('implement "seek()" on adapter')}emit(t,e){if("error"==t){if(!e.fatal){if(this.throttledErrors[null==e?void 0:e.code]++)return;setTimeout(()=>{this.throttledErrors[null==e?void 0:e.code]>1&&console.log("Error code ".concat(null==e?void 0:e.code," throttled ").concat(this.throttledErrors[null==e?void 0:e.code]," times")),this.throttledErrors[null==e?void 0:e.code]=0},1e3)}let t="";(null==e?void 0:e.code)&&(t=p[e.code]),(null==e?void 0:e.fatal)?console.error("Fatal error in streaming player: ".concat(t),e):console.warn("Non-fatal error in streaming player: ".concat(t),e)}nt.emit(this.uvp,t,e)}_handleTimeupdate(t){!this.isLive&&this.isAtEnd&&(this.emit("ended"),this.uvp.loop&&this.uvp.out?this.position=0:this.pause());const e={...t||{},position:this.position,duration:this.duration,min:this.minPosition,max:this.maxPosition};this.uvp.in&&(e.in=this.uvp.in),this.uvp.out&&(e.out=this.uvp.out),this.emit(t.type,e)}}{static get id(){return g}play(){this.videoElement&&(this.isAtEnd&&(this.position=0),this.videoElement.play())}pause(){this.videoElement&&this.videoElement.pause()}get paused(){return!!this.videoElement&&this.videoElement.paused}get volume(){return this.videoElement?this.videoElement.volume:0}set volume(t){this.videoElement&&(this.videoElement.volume=t)}get muted(){return!!this.videoElement&&this.videoElement.muted}set muted(t){this.videoElement&&(this.videoElement.muted=t)}get duration(){return super.duration}get providerDuration(){let t=this.videoElement?this.videoElement.duration:0;return t&&isFinite(t)?t:0}get position(){return super.position}set position(t){if(this.isLive||!this.videoElement)return;let e;e=t>=this.minPosition?P.toProviderPosition(this.uvp,t):this.videoElement.buffered?this.videoElement.buffered.start(0):0,this.videoElement.currentTime=e}get providerPosition(){const t=this.videoElement?this.videoElement.currentTime:0;return t&&isFinite(t)?t:0}get currentBitrate(){}bindMediaEvents(t){for(const e of it)switch(e){case"timeupdate":case"durationchange":case"seeked":case"seeking":t.addEventListener(e,this._handleTimeupdate);break;case"waiting":t.addEventListener(e,t=>{this.waiting=!0,this.emit(e,t)});break;case"canplay":t.addEventListener(e,s=>{this.emit(e,s),!this.uvp.autoplay&&t.paused?this.emit("pause",s):this.waiting&&!t.paused&&(this.waiting=!1,this.emit("playing",s))});break;case"playing":case"pause":t.addEventListener(e,t=>{this.emit(e,t),this.waiting=!1});break;case"ended":t.addEventListener(e,t=>{this.emit(e,t),this.uvp.loop&&this.play()});break;case"error":t.addEventListener(e,t=>{let s=h.PLAYER_ERROR;const i=null==t?void 0:t.code;switch(i){case MediaError.MEDIA_ERR_NETWORK:s=h.NETWORK_ERROR;break;case MediaError.MEDIA_ERR_DECODE:s=h.MEDIA_ERROR;break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:s=h.NOT_SUPPORTED;break;case MediaError.MEDIA_ERR_ABORTED:default:s=h.PLAYER_ERROR}this.emit(e,{fatal:!0,code:s,errorCode:i,errorType:s})});break;default:t.addEventListener(e,t=>{this.emit(e,t)})}}bindHtmlElements(t){this.videoElement=Et("video","",t)}async render(t){const e=this.uvp;this.bindHtmlElements(t);const s=this.videoElement;this.bindMediaEvents(s),this.volume=e.volume,this.muted=e.muted,this.videoSource=Et("source","",s);const i=this.videoSource;let r=['playmode="'.concat(e.coreResourceType||"4K",'"'),"pass_through=".concat(!!e.passThrough),"esvm=".concat(!!e.drm&&!!e.drm.esvm)];var a,n,o;a=i,n=["type","src"],o={type:e.type?"".concat(e.type,";").concat(r.join(";")):r,src:e.src},n.forEach(t=>{void 0!==o[t]&&a.setAttribute(t,o[t])}),i.addEventListener("error",t=>{let e=h.PLAYER_ERROR;const s=null==t?void 0:t.code;switch(s){case MediaError.MEDIA_ERR_NETWORK:e=h.NETWORK_ERROR;break;case MediaError.MEDIA_ERR_DECODE:case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:e=h.MEDIA_ERROR;break;case MediaError.MEDIA_ERR_ABORTED:default:e=h.PLAYER_ERROR}this.emit("error",{fatal:!0,code:e,errorCode:s,errorType:e})}),function(t,e,s){e.forEach(e=>t.toggleAttribute(e,!!s[e]))}(s,["autoplay"],e);const l=e.start||0;(e.start||this.uvp.in)&&(this.position=l),this.loaded=!0,await Promise.resolve().then(()=>{this.loaded&&(this.emit("ready",{provider:Te.id}),this.isLive!==this.metadata.isLive&&(this.metadata=Object.assign({},this.metadata,{isLive:this.isLive,canSkip:!0}),this.emitMetadata(this.metadata)))})}emitMetadata(t={}){const e=this.videoElement,s={duration:e.duration,videoHeight:e.videoHeight,videoWidth:e.videoWidth,displayHeight:e.clientHeight,displayWidth:e.clientWidth,bitrate:this.currentBitrate,subtitleTracks:this.subtitleTracks,subtitles:this.subtitles,audioTracks:this.audioTracks,audio:this.audio,...t};this.emit("metadata",s)}unload(){this.loaded=!1;const t=this.videoElement;if(t){t.pause();const e=this.videoSource;e&&(e.removeAttribute("src"),t.removeChild(e),this.videoSource=null),t.removeAttribute("src"),t.load(),t.parentElement&&t.parentElement.removeChild(t)}this.videoElement=null}}r.define(Te);class fe{constructor(t,e){this._playerDefault=t,this._onUpdateCaptionsSetting=e,this._captionsApiAvailability=!1,this._userSetCaptions=!1,this._systemSettingPending=!0,this._systemSetting=void 0}setSystemCaptionsSetting(t){this._systemSettingPending=!1,this._systemSetting=t,this._checkCaptionsStatus()}notifyCaptionsApiAvailability(){this._captionsApiAvailability=!0,this._checkCaptionsStatus()}notifyUserSetCaptions(){this._userSetCaptions=!0}_checkCaptionsStatus(){this._userSetCaptions||this._systemSettingPending||this._playerDefault!==this._systemSetting&&this._captionsApiAvailability&&this._onUpdateCaptionsSetting(this._systemSetting)}}let Se=ct.dashjs;class Pe extends Te{static get id(){return v}static set symbol(t){Se=t}constructor(t){super(t),!Se&&console.error("".concat("SceUvp >> "," missing dash.js symbol. Import it and supply it to SceUvp.use(id, cond, sym).")),this.onLoadedMetadata=this.onLoadedMetadata.bind(this),this.onTracksAdded=this.onTracksAdded.bind(this),this.onKeyError=this.onKeyError.bind(this),this.onAudioAdded=this.onAudioAdded.bind(this),this.onQualitiesAdded=this.onQualitiesAdded.bind(this),this.onQualityChange=this.onQualityChange.bind(this),this._handleTimeupdate=this._handleTimeupdate.bind(this),this._subtitleTracks=[]}get providerDuration(){const t=this.player?this.player.getActiveStream():null;return t?t.getDuration():null}get position(){return super.position}set position(t){const e=P.toProviderPosition(this.uvp,t);this.player.seek(e)}set audio(t){this.player.setCurrentTrack(this.player.getTracksFor("audio")[t])}get audio(){return parseInt(this.player.getCurrentTrackFor("audio").index)}get audioTracks(){return this.player.getTracksFor("audio").map(({index:t,lang:e})=>({id:t,lang:e,name:e}))}set systemSubtitles(t){var e;null===(e=this.captionSettingTracker)||void 0===e||e.setSystemCaptionsSetting(t)}set subtitles(t){var e;this.player.setTextTrack(!1===t?-1:t),null===(e=this.captionSettingTracker)||void 0===e||e.notifyUserSetCaptions()}get subtitles(){let t=this.player.getCurrentTextTrackIndex();return!isNaN(t)&&-1!=t&&parseInt(t)}get subtitleTracks(){return this._subtitleTracks}get currentBitrate(){if(!this.player)return null;let t,e;try{t=this.player.getQualityFor("video"),e=this.player.getBitrateInfoListFor("video")}catch(t){return null}const s=e?e[t]:null;return s?s.bitrate:null}onQualitiesAdded(t){}onAudioAdded(t){}onQualityChange(t){if("video"===t.mediaType&&t.newQuality>=0){const t=!!this.player.isDynamic();this.emitMetadata({isLive:t,canSkip:!t})}}onTracksAdded(t){var e;this._subtitleTracks=t.tracks.map((t,e)=>({id:e,lang:t.lang,name:t.lang})),null===(e=this.captionSettingTracker)||void 0===e||e.notifyCaptionsApiAvailability()}onLoadedMetadata(){this.videoElement.removeEventListener("loadedmetadata",this.onLoadedMetadata);const t=!!this.player.isDynamic();this.emitMetadata({isLive:t,canSkip:!t});const e=this.uvp.start||0;(e||this.uvp.in)&&(this.position=e)}onKeyError(t){let e=h.PLAYER_ERROR;const s=null==t?void 0:t.code;if(t.code>=this.player.ProtectionErrors.MEDIA_KEYERR_CODE&&t.code<=this.player.ProtectionErrors.MEDIA_KEY_MESSAGE_LICENSER_ERROR_CODE)e=h.DRM_ERROR;else{let t=this.player.Errors;switch(s){case t.MANIFEST_LOADER_PARSING_FAILURE_ERROR_CODE:case t.MANIFEST_LOADER_LOADING_FAILURE_ERROR_CODE:e=h.MANIFEST_ERROR;break;case t.CAPABILITY_MEDIASOURCE_ERROR_CODE:case t.MANIFEST_ERROR_ID_MULTIPLEXED_CODE:e=h.MEDIA_ERROR;break;case t.MEDIASOURCE_TYPE_UNSUPPORTED_CODE:e=h.NOT_SUPPORTED;break;case t.TIMED_TEXT_ERROR_ID_PARSE_CODE:e=h.TEXT_ERROR;break;case t.URL_RESOLUTION_FAILED_GENERIC_ERROR_CODE:e=h.NETWORK_ERROR;break;default:e=h.PLAYER_ERROR}}this.emit("error",{fatal:!0,code:e,errorCode:s,errorType:e})}async render(t){const e=this.uvp;this.bindHtmlElements(t);const s=this.videoElement;s.addEventListener("loadedmetadata",this.onLoadedMetadata),s.addEventListener("addtrack",this.onAudioAdded);var i=this.player=Se.MediaPlayer().create();window.dashPlayer=i,this.bindMediaEvents(s),i.on(Se.MediaPlayer.events.TEXT_TRACKS_ADDED,this.onTracksAdded),i.on(Se.MediaPlayer.events.PLAYBACK_METADATA_LOADED,this.onQualitiesAdded),i.on(Se.Protection.events.KEY_ERROR,this.onKeyError),i.on(Se.MediaPlayer.events.QUALITY_CHANGE_RENDERED,this.onQualityChange),this.volume=e.volume,this.muted=e.muted;let r={debug:{logLevel:e.isProspero?Se.Debug.LOG_LEVEL_NONE:Se.Debug.LOG_LEVEL_DEBUG},streaming:{isPlayStation:e.isProspero,coreResourceType:e.isProspero?e.coreResourceType:void 0,audioPassThrough:e.isProspero?e.audioPassThrough:void 0,abr:{initialBitrate:{video:e.targetBitrate&&e.targetBitrate>0?e.targetBitrate:-1}}}};if(e.drm&&(e.drm.esvm&&(r.streaming.ESVM=e.drm.esvm),e.drm.licenseRequest)){let t={"com.microsoft.playready":{serverURL:{"license-request":e.drm.licenseRequest}}};const s=t["com.microsoft.playready"];e.isProspero?s.distinctiveIdentifier=e.drm.distinctiveIdentifier?e.drm.distinctiveIdentifier:"required":s.distinctiveIdentifier="optional",e.drm.sessionTypes&&(s.sessionType=e.drm.sessionTypes[0]),s.serverURL["license-release"]=e.drm.licenseRelease,s.persistentState=e.drm.persistentState,i.setProtectionData(t)}i.updateSettings(r),!0===e.systemSubtitles?i.setTextDefaultEnabled(!0):(i.setTextDefaultEnabled(!1),this.captionSettingTracker=new fe(!1,t=>{t?this.player.enableText(!0):this.subtitles=!1})),i.initialize(s,e.src,e.autoplay),this.loaded=!0,await Promise.resolve().then(()=>this.emit("ready",{provider:Pe.id}))}unload(){this.loaded=!1,this.videoElement&&this.videoElement.parentElement&&this.videoElement.parentElement.removeChild(this.videoElement),this.player&&this.player.reset()}}r.define(Pe);let Re=ct.Hls;class ke extends Te{static get id(){return m}static set symbol(t){Re=t}static get symbol(){return Re}constructor(t){super(t),!Re&&console.error("".concat("SceUvp >> ",'missing hls.js "Hls" symbol. Import it globally or supply it to SceUvp.use(id, cond, symbol).')),this.onLevelLoadedEvent=this.onLevelLoadedEvent.bind(this),this.onLevelSwitched=this.onLevelSwitched.bind(this),this.onErrorEvent=this.onErrorEvent.bind(this),this.onStartLevel=this.onStartLevel.bind(this),this.onTracksAdded=this.onTracksAdded.bind(this),this.createHlsPlayer=this.createHlsPlayer.bind(this),this.render=this.render.bind(this)}get providerDuration(){const t=(this.hlsPlayer?this.hlsPlayer.levels:[]).find(t=>t&&t.details&&t.details.totalduration);return t?t.details.totalduration:null}set audio(t){this.hlsPlayer.audioTrack=t}get audio(){return this.hlsPlayer.audioTrack}get audioTracks(){return this.hlsPlayer.audioTracks.map(({id:t,lang:e,name:s,groupId:i})=>({id:t,lang:e,name:s,channels:i}))}set subtitles(t){!1===t?(this.hlsPlayer.subtitleTrack=-1,this.hlsPlayer.subtitleDisplay=!1):(this.hlsPlayer.subtitleDisplay=!0,this.hlsPlayer.subtitleTrack=t)}get subtitles(){let t=this.hlsPlayer.subtitleTrack;return-1===t&&(t=!1),this.hlsPlayer.subtitleDisplay&&t}get subtitleTracks(){return this.hlsPlayer.subtitleTracks.map(t=>({id:t.id,lang:t.lang,name:t.name}))}get currentBitrate(){const t=this.hlsPlayer;if(t&&t.currentLevel>=0){const e=t.levels?t.levels[t.currentLevel]:null;return e?e.bitrate:null}return null}onTracksAdded(t){}async render(t){Re=Re||ke.symbol;const e=this.uvp;this.bindHtmlElements(t);const s=this.videoElement,i=this.hlsPlayer=this.createHlsPlayer();i.on(Re.Events.LEVEL_LOADED,this.onLevelLoadedEvent),i.on(Re.Events.LEVEL_SWITCHED,this.onLevelSwitched),i.on(Re.Events.ERROR,this.onErrorEvent),i.on(Re.Events.MANIFEST_PARSED,this.onStartLevel),i.on(Re.Events.AUDIO_TRACK_LOADED,this.onTracksAdded),i.on(Re.Events.SUBTITLE_TRACK_LOADED,this.onTracksAdded),this.bindMediaEvents(s);const r=()=>{this.uvp.autoplay&&this.videoElement.play(),s.removeEventListener("canplay",r)};let a;s.addEventListener("canplay",r);try{a=await this.getSrc()}catch(t){return void this.emit("error",{fatal:!0,code:h.DRM_ERROR,errorCode:null==t?void 0:t.code,errorType:h.DRM_ERROR})}a&&await new Promise(t=>{i.once(Re.Events.MANIFEST_PARSED,t),i.loadSource(a),i.attachMedia(s)}),this.volume=e.volume,this.muted=e.muted,this.loaded=!0,await Promise.resolve().then(()=>{this.loaded&&this.emit("ready",{provider:Re.id})})}async getSrc(){return Promise.resolve(this.uvp.src)}onStartLevel(){if(this.uvp.targetBitrate&&this.uvp.targetBitrate>0)for(let t=this.hlsPlayer.levels.length-1;t>=0;--t){let e=this.hlsPlayer.abrBandWidthFactor>0?this.hlsPlayer.abrBandWidthFactor:.95;if(1e3*this.uvp.targetBitrate*e>=this.hlsPlayer.levels[t].bitrate){this.hlsPlayer.nextLoadLevel=t;break}}}createHlsPlayer(){const t=ke.symbol,e=this.uvp,s={debug:!e.isProspero,isPlayStation:e.isProspero,autoStartLoad:!0,coreResourceType:e.isProspero?e.coreResourceType:void 0,audioPassThrough:e.isProspero?e.audioPassThrough:void 0,startPosition:P.toProviderPosition(e,e.start)};return e.drm&&(void 0!==e.drm.esvm&&(s.ESVM=e.drm.esvm),e.drm.licenseRequest&&(s.emeEnabled=!0,s.drmSystem="PLAYREADY",s.playreadyLicenseUrl=e.drm.licenseRequest,e.drm.licenseRelease&&(s.releaseLicenseUrl=e.drm.licenseRelease),e.isProspero?e.drm.distinctiveIdentifier&&(s.distinctiveIdentifier=e.drm.distinctiveIdentifier):s.distinctiveIdentifier="optional",e.drm.sessionTypes&&(s.sessionTypes=e.drm.sessionTypes),e.drm.persistentState&&(s.persistentState=e.drm.persistentState))),new t(s)}onLevelLoadedEvent(t,e){const s=e&&e.details,i=s&&!!s.live;this.emitMetadata({isLive:i,canSkip:!i})}onLevelSwitched(t,e){if((e?e.level:-1)>=0){const t=e.details&&!!e.details.live;this.emitMetadata({isLive:t,canSkip:!t})}}onErrorEvent(t,e){let s=h.PLAYER_ERROR;const i=null==e?void 0:e.errorType;switch(i){case Re.ErrorTypes.NETWORK_ERROR:s=h.NETWORK_ERROR;break;case Re.ErrorTypes.MEDIA_ERROR:s=h.MEDIA_ERROR;break;case Re.ErrorTypes.OTHER:default:s=h.PLAYER_ERROR}this.emit("error",{...e,code:s,errorCode:i,errorType:s})}unload(){this.loaded=!1,this.videoElement&&this.videoElement.parentElement&&this.videoElement.parentElement.removeChild(this.videoElement),this.hlsPlayer&&this.hlsPlayer.destroy()}}r.define(ke);let Ae=ct.shaka;class Ce extends Te{static get id(){return y}static set symbol(t){Ae=t}static get symbol(){return Ae}constructor(t,e){super(t,e),!Ae&&console.error("".concat("SceUvp >> ",'missing shaka "Shaka" symbol. Import it globally or supply it to SceUvp.use(id, cond, symbol).')),this._onTracksChanged=this._onTracksChanged.bind(this),this._onError=this._onError.bind(this)}set subtitles(t){t=this.shakaPlayer.getTextTracks().find(({id:e})=>e===t),this.shakaPlayer.setTextTrackVisibility(!!t),t&&this.shakaPlayer.selectTextTrack(t)}get subtitles(){if(this.shakaPlayer.isTextTrackVisible()){let t=this.shakaPlayer.getTextTracks().find(({active:t})=>t);return t&&t.id}return!1}get subtitleTracks(){return this.shakaPlayer.getTextTracks().map(({id:t,language:e,label:s})=>({id:t,lang:e,name:null!=s?s:"".concat(e)+(t?" (".concat(t,")"):"")}))}set audio(t){if(!this.shakaPlayer)return;const e=this.shakaPlayer.getVariantTracks(),{audioId:s,videoId:i}=e.find(({active:t})=>t);if(isNaN(t))console.error("Wrong audio track ID in setAudioTrack");else if(s!==t){const s=e.find(({audioId:e,videoId:s})=>e===t&&s===i);s||console.error("No viable variant track found");const r=this.shakaPlayer.getTextTracks().find(({active:t})=>t);this.shakaPlayer.selectAudioLanguage(s.language,s.roles.length?s.roles[0]:null),r&&this.shakaPlayer.selectTextTrack(r)}}get audio(){if(!this.shakaPlayer)return 0;return this.shakaPlayer.getVariantTracks().find(({active:t})=>t).audioId}get audioTracks(){let t=[];return this.shakaPlayer?(this.shakaPlayer.getVariantTracks().forEach(({audioId:e,language:s,label:i,channelsCount:r})=>{t.find(({id:t})=>t===e)||t.push({id:e,lang:s,name:null!=i?i:"".concat(s," (").concat(qt("msgid_number_channels")+": ".concat(r),")"),channels:r})}),t):t}_onTracksChanged(){this.emitMetadata()}_onError(t){let e=h.PLAYER_ERROR;const s=null==t?void 0:t.category;switch(s){case Ae.util.Error.Category.NETWORK:e=h.NETWORK_ERROR;break;case Ae.util.Error.Category.TEXT:e=h.TEXT_ERROR;break;case Ae.util.Error.Category.STREAMING:case Ae.util.Error.Category.MEDIA:e=h.MEDIA_ERROR;break;case Ae.util.Error.Category.MANIFEST:e=h.MANIFEST_ERROR;break;case Ae.util.Error.Category.DRM:e=h.DRM_ERROR;break;case Ae.util.Error.Category.PLAYER:e=h.PLAYER_ERROR;break;case Ae.util.Error.Category.CAST:case Ae.util.Error.Category.STORAGE:default:e=h.PLAYER_ERROR}this.emit("error",{fatal:t.severity===Ae.util.Error.Severity.CRITICAL,code:e,errorCode:s,errorType:e})}async render(t){const e=this.uvp;this.bindHtmlElements(t),this.bindMediaEvents(this.videoElement);const s=this.shakaPlayer=new Ae.Player(this.videoElement);if(window.shakaPlayer=s,s.configure(this.config||{}),this.config.textDisplayFactory){const t=this.config.textDisplayFactory,e=this.videoElement;s.configure({textDisplayFactory:function(){return t(e)}})}const i={playRangeStart:this.uvp.in,playRangeEnd:this.uvp.out};s.configure(i),s.addEventListener("textchanged",this._onTracksChanged),s.addEventListener("texttrackvisibility",this._onTracksChanged),s.addEventListener("trackschanged",this._onTracksChanged),s.addEventListener("error",this._onError),this.emit("ready",{provider:Ce.id});try{await s.load(e.src,e.start)}catch(t){return void(t.code!=Ae.util.Error.Code.LOAD_INTERRUPTED&&this._onError(t))}this.emitMetadata(),e.autoplay&&this.videoElement.play(),this.loaded=!0}emitMetadata(){const t=this.shakaPlayer.isLive();this.emit("metadata",{isLive:t,canSkip:!t,subtitles:this.subtitles,subtitleTracks:this.subtitleTracks,audio:this.audio,audioTracks:this.audioTracks})}unload(){super.unload(),this.shakaPlayer.destroy()}}r.define(Ce),e.set("Player",zt),e.set("Controls",ne),e.set("html5Video",Te),dt.useSource(class{constructor(t){_e=t,window.addEventListener("keydown",be)}}),nt.add((function(t,e,s){return t.triggerEvent(e,s)}));export default a;export{it as EVENTS};
//# sourceMappingURL=sce-uvp.esm.js.map
